# SPDX-License-Identifier: Apache-2.0
# Copyright Authors of bpfman

# Makefile for eBPF dispatcher compilation.

LIBBPF_CFLAGS := $(shell pkg-config --cflags libbpf)

# Dynamic architecture detection using uname
TARGET_ARCH ?= $(shell uname -m)

ifeq ($(TARGET_ARCH),x86_64)
  TARGET_ARCH_DEFINE := -D__TARGET_ARCH_x86
else ifeq ($(TARGET_ARCH),i686)
  TARGET_ARCH_DEFINE := -D__TARGET_ARCH_x86
else ifeq ($(TARGET_ARCH),aarch64)
  TARGET_ARCH_DEFINE := -D__TARGET_ARCH_arm64
else ifeq ($(TARGET_ARCH),powerpc64le)
  TARGET_ARCH_DEFINE := -D__TARGET_ARCH_powerpc
else ifeq ($(TARGET_ARCH),s390x)
  TARGET_ARCH_DEFINE := -D__TARGET_ARCH_s390
else
  $(error Unsupported architecture: $(TARGET_ARCH))
endif

SOURCES := $(wildcard *.bpf.c)
# Use OUT_DIR if provided, otherwise use the directory containing this Makefile.
OUT_DIR ?= $(CURDIR)
OBJECTS := $(addprefix $(OUT_DIR)/,$(SOURCES:.bpf.c=.bpf.o))
DEP_FILES := $(addprefix $(OUT_DIR)/,$(SOURCES:.bpf.c=.bpf.d))

# Go package directory for embedding
GO_PKG_DIR := ../pkg/bpfman/dispatcher

all: $(OBJECTS) install

install: $(OBJECTS)
	cp $(OUT_DIR)/xdp_dispatcher_v2.bpf.o $(GO_PKG_DIR)/
	cp $(OUT_DIR)/tc_dispatcher.bpf.o $(GO_PKG_DIR)/

$(OUT_DIR)/%.bpf.o: %.bpf.c Makefile | $(OUT_DIR)
	clang $(LIBBPF_CFLAGS) -g -O2 -target bpfel -c $(TARGET_ARCH_DEFINE) -MD -MP -MF$(OUT_DIR)/$*.bpf.d $< -o $@

$(OUT_DIR):
	mkdir -p $(OUT_DIR)

.PHONY: clean
clean:
	rm -f $(OBJECTS) $(DEP_FILES)
	rm -f $(GO_PKG_DIR)/*.bpf.o

.PHONY: test-pkgconfig
test-pkgconfig:
	pkg-config --exists libbpf

.PHONY: debug
debug:
	@echo "TARGET_ARCH: $(TARGET_ARCH)"
	@echo "TARGET_ARCH_DEFINE: $(TARGET_ARCH_DEFINE)"
	@echo "LIBBPF_CFLAGS: $(LIBBPF_CFLAGS)"
	@which clang
	@ls -la *.bpf.c

-include $(DEP_FILES)
